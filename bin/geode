#!/bin/bash

# Geode: The Gemini CLI Persona Wrapper
# Version: 0.2.0-pre (V1.5 Unified Packages)

# 1. Configuration & Paths
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do 
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" 
done
GEODE_HOME="$( cd -P "$( dirname "$SOURCE" )/.." >/dev/null 2>&1 && pwd )"

CONFIG_FILE="$HOME/.geode_config"
STATE_DIR="$HOME/.geode"
LAST_CLEAN_FILE="$STATE_DIR/last_clean"

# Default Paths (Can be overridden in CONFIG_FILE)
G_KNOWLEDGE_DIR="$GEODE_HOME/knowledge"
G_PACKAGE_ROOT="$GEODE_HOME/packages"
G_CORE_PERSONA="$GEODE_HOME/core/CORE_PERSONA.md"
G_SAVER_SCRIPT="$GEODE_HOME/tools/save_session.py"

# Load user config if it exists
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
fi

# 2. Lazy Background Cleanup
mkdir -p "$STATE_DIR"
current_time=$(date +%s)
last_clean_time=0
if [ -f "$LAST_CLEAN_FILE" ]; then
    last_clean_time=$(cat "$LAST_CLEAN_FILE" 2>/dev/null)
fi

if [ $((current_time - last_clean_time)) -gt 86400 ]; then
    if [ -f "$GEODE_HOME/tools/cleanup_sessions.sh" ]; then
        bash "$GEODE_HOME/tools/cleanup_sessions.sh" > /dev/null 2>&1 &
        echo $current_time > "$LAST_CLEAN_FILE"
    fi
fi

# 3. Helpers
usage() {
    echo "Usage: geode [command] [persona]"
    echo ""
    echo "Commands:"
    echo "  run <persona>   Start a session with a specific persona (default command)"
    echo "  list            List available personas"
    echo "  config          Show current configuration"
    echo "  help            Show this help message"
    echo ""
    echo "ðŸ’¡ Pro Tip: To create new personas or understand how this framework works,"
    echo "            run 'geode sys' to chat with the Geode Expert."
    exit 1
}

find_persona_file() {
    local name=$1
    # Core Protection: sys and general always come from core
    if [[ "$name" == "sys" || "$name" == "general" ]]; then
        echo "$G_PACKAGE_ROOT/core/$name/persona.md"
        return
    fi
    # Priority: Local > Installed > Core
    if [ -f "$G_PACKAGE_ROOT/local/$name/persona.md" ]; then
        echo "$G_PACKAGE_ROOT/local/$name/persona.md"
    elif [ -f "$G_PACKAGE_ROOT/installed/$name/persona.md" ]; then
        echo "$G_PACKAGE_ROOT/installed/$name/persona.md"
    elif [ -f "$G_PACKAGE_ROOT/core/$name/persona.md" ]; then
        echo "$G_PACKAGE_ROOT/core/$name/persona.md"
    fi
}

# 4. Command: List Personas
list_personas() {
    echo "Available Geode Personas:"
    
    # 1. Gather all potential names
    local names
    names=$(ls -d "$G_PACKAGE_ROOT/core/"* 2>/dev/null | xargs -n 1 basename 2>/dev/null)
    names+=" "$(ls -d "$G_PACKAGE_ROOT/installed/"* 2>/dev/null | xargs -n 1 basename 2>/dev/null)
    names+=" "$(ls -d "$G_PACKAGE_ROOT/local/"* 2>/dev/null | xargs -n 1 basename 2>/dev/null)
    unique_names=$(echo "$names" | tr ' ' '\n' | sort -u)

    # 2. Bucketize based on resolved path
    local list_local=""
    local list_installed=""
    local list_core=""

    for name in $unique_names; do
        [ -z "$name" ] && continue
        persona_file=$(find_persona_file "$name")
        
        if [ -f "$persona_file" ]; then
            # Extract objective
            desc=$(grep -m 1 "Objective:" "$persona_file" | sed -E 's/.*Objective:[ *]*//' | sed 's/[ *]*$//')
            [ -z "$desc" ] && desc="No objective defined."
            
            # Format the line
            line=$(printf "  - %-10s : %s" "$name" "$desc")
            
            # Determine source category and append with explicit newline
            if [[ "$persona_file" == *"/packages/local/"* ]]; then
                list_local="${list_local}${line}"$'\n'
            elif [[ "$persona_file" == *"/packages/installed/"* ]]; then
                list_installed="${list_installed}${line}"$'\n'
            elif [[ "$persona_file" == *"/packages/core/"* ]]; then
                list_core="${list_core}${line}"$'\n'
            fi
        fi
    done

    # 3. Print Groups
    if [ -n "$list_local" ]; then
        echo ""
        echo "LOCAL (Private & Custom)"
        echo -n "$list_local"
    fi

    if [ -n "$list_installed" ]; then
        echo ""
        echo "INSTALLED (Community Packages)"
        echo -n "$list_installed"
    fi

    # Always show Core (even if theoretically empty, though sys/general exist)
    echo ""
    echo "CORE (Built-in Standards)"
    echo -n "$list_core"
    echo ""
}

# 5. Command: Run Persona
run_persona() {
    local persona=$1
    [ -z "$persona" ] && persona="general"

    local persona_file=$(find_persona_file "$persona")

    if [ ! -f "$persona_file" ]; then
        echo "âŒ Persona '$persona' not found."
        exit 1
    fi

    # Determine Package Home
    local package_home=$(dirname "$persona_file")
    
    echo "ðŸ’Ž Initializing Geode: [$persona]"
    
    # Ensure session directory and state directory exist
    mkdir -p "$G_KNOWLEDGE_DIR/sessions/$persona"
    mkdir -p "$STATE_DIR"

    # Combine Core + Persona for the system prompt
    local active_system_md="$STATE_DIR/system_${persona}_$$.md"
    cat "$G_CORE_PERSONA" "$persona_file" > "$active_system_md"
    trap "rm -f '$active_system_md'" EXIT

    # Tool Discovery: If package has a tools/ dir, add it to PATH
    if [ -d "$package_home/tools" ]; then
        export PATH="$package_home/tools:$PATH"
    fi

    # Launch Gemini CLI
    GEMINI_SYSTEM_MD="$active_system_md" gemini

    # Post-session: Run the Saver
    if [ -f "$G_SAVER_SCRIPT" ]; then
        python3 "$G_SAVER_SCRIPT" "$G_KNOWLEDGE_DIR/sessions/$persona"
    fi
}

# 6. Argument Parsing
case "$1" in
    list)
        list_personas
        ;;
    config)
        echo "Geode Configuration:"
        echo "  Home:          $GEODE_HOME"
        echo "  Packages:      $G_PACKAGE_ROOT"
        echo "  Knowledge:     $G_KNOWLEDGE_DIR"
        echo "  Core Logic:    $G_CORE_PERSONA"
        ;; 
    help|--help|-h)
        usage
        ;; 
    run)
        shift
        run_persona "$1"
        ;; 
    "")
        run_persona "general"
        ;; 
    *)
        run_persona "$1"
        ;; 
esac
