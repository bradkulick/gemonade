#!/bin/bash

# Gemonade: The Gemini CLI Persona Wrapper
# Version: 2.0.4 (Reference Gem Knowledge)

# 1. Configuration & Paths
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do 
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" 
done
GEMONADE_HOME="$( cd -P "$( dirname "$SOURCE" )/.." >/dev/null 2>&1 && pwd )"

CONFIG_FILE="$HOME/.gemonade_config"
STATE_DIR="$HOME/.gemonade"
LAST_CLEAN_FILE="$STATE_DIR/last_clean"

# Default Paths (Can be overridden in CONFIG_FILE)
G_KNOWLEDGE_DIR="$GEMONADE_HOME/knowledge"
G_PACKAGE_ROOT="$GEMONADE_HOME/packages"
G_CORE_PERSONA="$GEMONADE_HOME/core/CORE_PERSONA.md"
G_SAVER_SCRIPT="$GEMONADE_HOME/tools/save_session.py"
G_INSTALLED_DIR="$G_PACKAGE_ROOT/installed"

# Load user config if it exists
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
fi

# 2. Lazy Background Cleanup
mkdir -p "$STATE_DIR"
current_time=$(date +%s)
last_clean_time=0
if [ -f "$LAST_CLEAN_FILE" ]; then
    last_clean_time=$(cat "$LAST_CLEAN_FILE" 2>/dev/null)
fi

if [ $((current_time - last_clean_time)) -gt 86400 ]; then
    if [ -f "$GEMONADE_HOME/tools/cleanup_sessions.sh" ]; then
        bash "$GEMONADE_HOME/tools/cleanup_sessions.sh" > /dev/null 2>&1 &
        echo $current_time > "$LAST_CLEAN_FILE"
    fi
fi

# 3. Helpers
usage() {
    echo "Usage: gemonade [command] [gem]"
    echo ""
    echo "Commands:"
    echo "  run <gem>               Start a session (default command)"
    echo "  list                    List available Gems"
    echo "  install <url|repo>      Install a Gem from Git"
    echo "  uninstall <gem>         Remove an installed Gem"
    echo "  update <gem>            Update an installed Gem"
    echo "  config                  Show current configuration"
    echo "  help                    Show this help message"
    echo ""
    echo "üí° Pro Tip: To create new Gems or understand how this framework works,"
    echo "            run 'gemonade sys' to chat with the Gemonade Expert."
    exit 1
}

find_persona_file() {
    local name=$1
    # Core Protection: sys and general always come from core
    if [[ "$name" == "sys" || "$name" == "general" ]]; then
        echo "$G_PACKAGE_ROOT/core/$name/persona.md"
        return
    fi
    # Priority: Local > Installed > Core
    if [ -f "$G_PACKAGE_ROOT/local/$name/persona.md" ]; then
        echo "$G_PACKAGE_ROOT/local/$name/persona.md"
    elif [ -f "$G_INSTALLED_DIR/$name/persona.md" ]; then
        echo "$G_INSTALLED_DIR/$name/persona.md"
    elif [ -f "$G_PACKAGE_ROOT/core/$name/persona.md" ]; then
        echo "$G_PACKAGE_ROOT/core/$name/persona.md"
    fi
}

get_json_value() {
    local file=$1
    local key=$2
    if [ -f "$file" ]; then
        # Robust Python parsing instead of fragile sed/grep
        python3 -c "import json, sys; data=json.load(open('$file')); print(data.get('$key', ''))" 2>/dev/null
    fi
}

# 4. Command: Install
install_gem() {
    local repo_url=$1
    if [ -z "$repo_url" ]; then
        echo "‚ùå Usage: gemonade install <git-url> or <user/repo>"
        exit 1
    fi

    # Handle "user/repo" shorthand
    if [[ "$repo_url" != http* && "$repo_url" != git@* ]]; then
        repo_url="https://github.com/$repo_url.git"
    fi

    # Extract name from URL
    local repo_name=$(basename "$repo_url" .git)
    local install_path="$G_INSTALLED_DIR/$repo_name"

    if [ -d "$install_path" ]; then
        echo "‚ö†Ô∏è  Gem directory '$repo_name' already exists."
        read -p "Reinstall? [y/N] " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then exit 1; fi
        rm -rf "$install_path"
    fi

    echo "üì¶ Cloning $repo_url..."
    mkdir -p "$G_INSTALLED_DIR"
    git clone "$repo_url" "$install_path" || { echo "‚ùå Clone failed"; exit 1; }

    # --- Smart Manifest Renaming ---
    local manifest_name=$(get_json_value "$install_path/gem.json" "name")
    if [ -n "$manifest_name" ] && [ "$manifest_name" != "$repo_name" ]; then
        if [ -d "$G_INSTALLED_DIR/$manifest_name" ]; then
            echo "‚ö†Ô∏è  A Gem named '$manifest_name' is already installed. Keeping original folder name '$repo_name'."
        else
            echo "üè∑Ô∏è  Renaming '$repo_name' to '$manifest_name' (per gem.json)..."
            mv "$install_path" "$G_INSTALLED_DIR/$manifest_name"
            install_path="$G_INSTALLED_DIR/$manifest_name"
            repo_name=$manifest_name
        fi
    fi

    echo "‚öôÔ∏è  Configuring '$repo_name'..."
    hydrate_gem "$install_path"

    echo "‚úÖ Successfully installed '$repo_name'."
}

# 5. Command: Uninstall
uninstall_gem() {
    local name=$1
    local path="$G_INSTALLED_DIR/$name"

    if [ -z "$name" ]; then echo "‚ùå Usage: gemonade uninstall <name>"; exit 1; fi
    if [[ "$name" == "sys" || "$name" == "general" ]]; then echo "‚ùå Cannot uninstall Core gems."; exit 1; fi
    if [ ! -d "$path" ]; then echo "‚ùå Gem '$name' not found in Installed packages."; exit 1; fi

    echo "üóëÔ∏è  Uninstalling '$name'..."
    rm -rf "$path"
    echo "‚úÖ Removed package files. (Session logs preserved)."
}

# 6. Command: Hydrate (Setup Venv)
hydrate_gem() {
    local path=$1
    local gem_json="$path/gem.json"
    
    # Check for requirements in JSON or file presence
    local req_file=""
    if [ -f "$gem_json" ]; then
        # Extract from JSON if present
        local json_req=$(get_json_value "$gem_json" "python_dependencies")
        if [ -n "$json_req" ]; then req_file="$path/$json_req"; fi
    fi
    
    # Fallback/Convention
    if [ -z "$req_file" ] && [ -f "$path/requirements.txt" ]; then
        req_file="$path/requirements.txt"
    fi

    if [ -n "$req_file" ] && [ -f "$req_file" ]; then
        echo "üêç Python dependencies detected. Creating isolated environment..."
        python3 -m venv "$path/.venv"
        "$path/.venv/bin/pip" install -r "$req_file"
        echo "‚úÖ Virtual environment created."
    fi
}

# 7. Command: List Personas
list_personas() {
    echo "Available Gemonade Gems:"
    
    # 1. Gather all potential names
    local names
    names=$(ls -d "$G_PACKAGE_ROOT/core/"* 2>/dev/null | xargs -n 1 basename 2>/dev/null)
    names+=" "$(ls -d "$G_INSTALLED_DIR/"* 2>/dev/null | xargs -n 1 basename 2>/dev/null)
    names+=" "$(ls -d "$G_PACKAGE_ROOT/local/"* 2>/dev/null | xargs -n 1 basename 2>/dev/null)
    unique_names=$(echo "$names" | tr ' ' '\n' | sort -u)

    # 2. Bucketize based on resolved path
    local list_local=""
    local list_installed=""
    local list_core=""

    for name in $unique_names; do
        [ -z "$name" ] && continue
        persona_file=$(find_persona_file "$name")
        
        if [ -f "$persona_file" ]; then
            # Extract objective
            desc=$(grep -m 1 "Objective:" "$persona_file" | sed -E 's/.*Objective:[ *]*//' | sed 's/[ *]*$//')
            [ -z "$desc" ] && desc="No objective defined."
            
            # Format the line
            line=$(printf "  - %-15s : %s" "$name" "$desc")
            
            # Determine source category and append with explicit newline
            if [[ "$persona_file" == *"/packages/local/"* ]]; then
                list_local="${list_local}${line}"$'\n'
            elif [[ "$persona_file" == *"/packages/installed/"* ]]; then
                list_installed="${list_installed}${line}"$'\n'
            elif [[ "$persona_file" == *"/packages/core/"* ]]; then
                list_core="${list_core}${line}"$'\n'
            fi
        fi
    done

    # 3. Print Groups
    echo ""
    echo "LOCAL (Private & Custom)"
    [ -n "$list_local" ] && echo -n "$list_local" || echo "  (none)"

    echo ""
    echo "INSTALLED (Community Gems)"
    [ -n "$list_installed" ] && echo -n "$list_installed" || echo "  (none)"

    echo ""
    echo "CORE (Built-in Standards)"
    echo -n "$list_core"
    echo ""
}

# 8. Command: Run Persona
run_persona() {
    local persona=$1
    [ -z "$persona" ] && persona="general"

    local persona_file=$(find_persona_file "$persona")

    if [ ! -f "$persona_file" ]; then
        echo "‚ùå Persona '$persona' not found."
        exit 1
    fi

    # Determine Package Home
    local package_home=$(dirname "$persona_file")
    
    echo "üíé Initializing Gemonade: [$persona]"
    
    # Ensure session directory and state directory exist
    mkdir -p "$G_KNOWLEDGE_DIR/sessions/$persona"
    mkdir -p "$STATE_DIR"

    # Hydration Check (Just in case user manually created folder)
    if [ ! -d "$package_home/.venv" ] && [ -f "$package_home/requirements.txt" ]; then
        echo "‚ö†Ô∏è  Missing environment. Hydrating..."
        hydrate_gem "$package_home"
    fi

    # Combine Core + Persona for the system prompt
    local active_system_md="$STATE_DIR/system_${persona}_$$.md"
    cat "$G_CORE_PERSONA" "$persona_file" > "$active_system_md"
    trap "rm -f '$active_system_md'" EXIT

    # --- Runtime Environment Setup ---
    
    # 1. Tools Path
    if [ -d "$package_home/tools" ]; then
        export PATH="$package_home/tools:$PATH"
    fi
    
    # 2. Python Venv (The Critical Bit)
    if [ -d "$package_home/.venv" ]; then
        # We prepend the venv bin to PATH so 'python3' calls use the venv
        export PATH="$package_home/.venv/bin:$PATH"
        # We also set VIRTUAL_ENV variable for politeness
        export VIRTUAL_ENV="$package_home/.venv"
    fi

    # Launch Gemini CLI
    GEMINI_SYSTEM_MD="$active_system_md" gemini

    # Post-session: Run the Saver
    if [ -f "$G_SAVER_SCRIPT" ]; then
        # Note: We use the SYSTEM python for the saver, not the Gem's python
        /usr/bin/env python3 "$G_SAVER_SCRIPT" "$G_KNOWLEDGE_DIR/sessions/$persona"
    fi
}

# 9. Command Dispatch
case "$1" in
    list)
        list_personas
        ;;
    install)
        shift
        install_gem "$@"
        ;;
    uninstall)
        shift
        uninstall_gem "$@"
        ;;
    update) 
        shift
        name=$1
        path="$G_INSTALLED_DIR/$name"
        if [ -d "$path" ]; then
            echo "‚¨áÔ∏è  Updating $name..."
            (cd "$path" && git pull)
            hydrate_gem "$path"
        else
            echo "‚ùå Gem not found."
        fi
        ;;
    config)
        echo "Gemonade Configuration:"
        echo "  Home:          $GEMONADE_HOME"
        echo "  Packages:      $G_PACKAGE_ROOT"
        echo "  Knowledge:     $G_KNOWLEDGE_DIR"
        echo "  Core Logic:    $G_CORE_PERSONA"
        ;;
    help|--help|-h)
        usage
        ;;
    run)
        shift
        run_persona "$1"
        ;;
    "")
        run_persona "general"
        ;;
    *)
        run_persona "$1"
        ;;
esac
